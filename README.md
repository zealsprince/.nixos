# .nixos

This repository is a **flake-based** Nix configuration that supports:

- **NixOS** system configuration (per-host)
- **Home Manager** user configuration (generic + portable)
- A clean separation between:
  - **host-specific** hardware/boot settings (e.g. Secure Boot, disk layout)
  - **reusable** modules (desktop, programs, defaults)
  - **WM-specific** Home Manager configuration (e.g. Plasma 6)

Goals:

- enable reuse of the Home Manager profile on **any** machine (NixOS or “just nix”),
- allow adding new NixOS hosts without inheriting dual-boot / Secure Boot specifics,
- allow swapping window managers by switching a Home Manager module,
- keep Nix config and “real dotfiles” cleanly separated.

## Dotfiles vs Nix config

This repo (`.nixos`) is the **NixOS + Home Manager** configuration.

“Real dotfiles” (things you’d traditionally keep in `~/.zshrc`, `~/.tmux.conf`, `~/.vimrc`, and script bins) live in a separate repository:

- `zealsprince/.dotfiles`

That repo is the source of truth for CLI dotfiles such as:
- Zsh (`.zshrc`, `.p10k.zsh`, themes/plugins)
- Tmux (`.tmux.conf`)
- Vim (`.vimrc` and related assets)
- user scripts (`bin/`)

Home Manager in this repo links those files into place so they stay consistent across machines.

## Directory layout

```
.nixos/
  flake.nix                     # Flake outputs: NixOS + Home Manager
  configuration.nix             # Legacy delegator (kept for familiarity)
  home.nix                      # Home Manager entrypoint (composes modules)
  packages.nix                  # Deprecated stub (packages live in a module now)

  hosts/
    ANDREW-DREAMREAPER/
      default.nix               # Host entrypoint (imports host + reusable modules)
      hardware-configuration.nix# Generated hardware config (host-specific)
      boot-secureboot.nix       # Secure Boot / Lanzaboote / bootloader (host-specific)

  modules/
    nixos/
      common.nix                # Reusable base NixOS defaults (locale, nix settings, etc.)
      packages.nix              # Reusable system-wide packages
      desktop/
        plasma6.nix             # Plasma 6 + SDDM + audio/printing (option-driven)
      programs/
        1password.nix           # 1Password NixOS module config (option-driven)
      security/
        howdy.nix               # Howdy + PAM integration (option-driven)

    home/
      base.nix                  # Cross-platform HM (zsh/git/ssh/packages)
      wm/
        plasma6.nix             # Plasma-specific HM (autostart + kglobalshortcutsrc)
```

## Philosophy / separation of concerns

### Host-specific things live under `hosts/<hostname>/`
Examples:
- disk layout, LUKS, filesystem UUIDs (`hardware-configuration.nix`)
- Secure Boot and Lanzaboote config
- GPU initrd modules
- machine hostname (`networking.hostName`)

This ensures new users can add their own host folder without inheriting bootloader or disk assumptions from existing hosts.

### Reusable system modules live under `modules/nixos/`
Examples:
- `nix.settings`, GC, locale defaults
- desktop environment modules (Plasma 6)
- program modules (1Password)
- security modules (Howdy)

These modules are meant to be sharable across all hosts.

### Home Manager is split by WM
- `modules/home/base.nix` is usable on non-NixOS too.
- `modules/home/wm/plasma6.nix` contains KDE-specific bits:
  - Autostart entries (`~/.config/autostart/*.desktop`)
  - Plasma global shortcuts (`~/.config/kglobalshortcutsrc`)
  - Yakuake sizing (`~/.config/yakuakerc`)

## Flake outputs

### NixOS outputs
- `nixosConfigurations.ANDREW-DREAMREAPER`

This is a **host-scoped** system build that imports:
- `hosts/ANDREW-DREAMREAPER/default.nix`
- reusable modules under `modules/nixos/*`
- external modules (Home Manager, Lanzaboote, Howdy, etc.)

### Home Manager outputs
- `homeConfigurations.zealsprince`

This is a **generic** user profile that can be applied on:
- NixOS
- non-NixOS systems that have the Nix package manager + Home Manager

It uses `home.nix`, which composes:
- `modules/home/base.nix`
- `modules/home/wm/plasma6.nix`

## How to use

### NixOS (this host)
From the `.nixos` directory:

```
sudo nixos-rebuild switch --flake .#YOUR-HOST
```

### Home Manager (generic, portable)
On any machine with Nix + Home Manager installed:

```
home-manager switch --flake .#zealsprince
```

This will update files in the user’s home directory (`~/.config`, `~/.local`, etc.).
It does not “overwrite a machine”; it applies to the **current user account** where the command is executed.

## Adding a new NixOS host

1. Create a new host folder:
   - `hosts/MY-HOST/`

2. Add:
   - `hosts/MY-HOST/hardware-configuration.nix` (generated by NixOS)
   - `hosts/MY-HOST/default.nix` (imports reusable modules + your host config)
   - optionally `hosts/MY-HOST/boot-secureboot.nix` (or other boot module)

3. Add a new entry in `flake.nix` under `nixosConfigurations`.

This keeps machine-specific settings isolated.

## Switching WM / desktop environment

Home Manager is structured so WM-specific behavior is isolated.

- Base config: `modules/home/base.nix`
- Plasma-specific: `modules/home/wm/plasma6.nix`

To add a new WM, create a new module under:

- `modules/home/wm/<wm>.nix`

Then update `home.nix` to import and enable that module instead of Plasma 6.

## Notes

### `configuration.nix`
This file is retained as a lightweight delegator for people expecting it,
but the "real" entrypoints are host modules under `hosts/<hostname>/default.nix`.

### `packages.nix`
This is deprecated and currently a stub to avoid breaking old imports.
System packages are managed via `modules/nixos/packages.nix`.
